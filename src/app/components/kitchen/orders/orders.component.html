<div class="orders-container">
    <!-- Header -->
    <div class="page-header mb-4">
        <div class="page-title">
            <h1>KDS Pro</h1>
            <p class="page-subtitle">Sistema de gestión de órdenes</p>
        </div>
    </div>

    <p-tabView styleClass="kds-tabs">
        <!-- KITCHEN TAB -->
        <p-tabPanel header="Cocina" leftIcon="pi pi-box">
            <!-- Kanban Columns -->
            <div class="kanban-board" *ngIf="kitchenItems && kitchenItems.length > 0">
                <!-- Column: Pendientes -->
                <div class="kanban-column">
                    <div class="column-header glass-card">
                        <div class="column-title">
                            <i class="pi pi-clock"></i>
                            <h3>Pendientes</h3>
                        </div>
                        <p-tag [value]="getPendingKitchenOrders().length.toString()" severity="info"></p-tag>
                    </div>
                    <div class="column-content">
                        <div *ngFor="let order of getPendingKitchenOrders(); let i = index"
                             class="order-card glass-card hover-lift stagger-item"
                             [class.order-urgent]="getSeverity(order.createdAt) === 'danger'"
                             [class.order-warning]="getSeverity(order.createdAt) === 'warning'"
                             [style.animation-delay]="(i * 0.05) + 's'">
                            
                            <app-order-timer [startTime]="order.createdAt"></app-order-timer>

                            <div class="order-table">
                                <i class="pi pi-table"></i>
                                <span>{{order.table?.name}}</span>
                            </div>

                            <div class="order-item">
                                <span class="order-quantity">{{order.quantity}}x</span>
                                <span class="order-name">{{order.meal?.name}}</span>
                            </div>

                            <div class="order-notes" *ngIf="order.aditional">
                                <i class="pi pi-comment"></i>
                                <span>{{order.aditional}}</span>
                            </div>

                            <div class="order-actions">
                                <button pButton 
                                        *ngIf="isOnlineOrder(order)"
                                        label="Cancelar" 
                                        severity="danger" 
                                        icon="pi pi-times"
                                        [outlined]="true"
                                        size="small"
                                        (click)="cancelOrder($event, order)"></button>
                                
                                <button pButton 
                                        label="Iniciar Preparación" 
                                        severity="warning" 
                                        icon="pi pi-cog"
                                        class="w-full"
                                        (click)="changeStatusOrder($event, order, 2)"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column: En Preparación -->
                <div class="kanban-column">
                    <div class="column-header glass-card">
                        <div class="column-title">
                            <i class="pi pi-cog"></i>
                            <h3>En Preparación</h3>
                        </div>
                        <p-tag [value]="getInProgressKitchenOrders().length.toString()" severity="warning"></p-tag>
                    </div>
                    <div class="column-content">
                        <div *ngFor="let order of getInProgressKitchenOrders(); let i = index"
                             class="order-card glass-card hover-lift stagger-item"
                             [class.order-urgent]="getSeverity(order.createdAt) === 'danger'"
                             [style.animation-delay]="(i * 0.05) + 's'">
                            
                            <app-order-timer [startTime]="order.createdAt"></app-order-timer>

                            <div class="order-table">
                                <i class="pi pi-table"></i>
                                <span>{{order.table?.name}}</span>
                            </div>

                            <div class="order-item">
                                <span class="order-quantity">{{order.quantity}}x</span>
                                <span class="order-name">{{order.meal?.name}}</span>
                            </div>

                            <div class="order-notes" *ngIf="order.aditional">
                                <i class="pi pi-comment"></i>
                                <span>{{order.aditional}}</span>
                            </div>

                            <div class="order-actions">
                                <button pButton 
                                        label="Marcar como Listo" 
                                        severity="success" 
                                        icon="pi pi-check"
                                        class="w-full"
                                        (click)="changeStatusOrder($event, order, 3)"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column: Listos -->
                <div class="kanban-column">
                    <div class="column-header glass-card">
                        <div class="column-title">
                            <i class="pi pi-check-circle"></i>
                            <h3>Listos</h3>
                        </div>
                        <p-tag [value]="getReadyKitchenOrders().length.toString()" severity="success"></p-tag>
                    </div>
                    <div class="column-content">
                        <div *ngFor="let order of getReadyKitchenOrders(); let i = index"
                             class="order-card glass-card hover-lift stagger-item ready-card"
                             [style.animation-delay]="(i * 0.05) + 's'">
                            
                            <app-order-timer [startTime]="order.createdAt"></app-order-timer>

                            <div class="order-table">
                                <i class="pi pi-table"></i>
                                <span>{{order.table?.name}}</span>
                            </div>

                            <div class="order-item">
                                <span class="order-quantity">{{order.quantity}}x</span>
                                <span class="order-name">{{order.meal?.name}}</span>
                            </div>

                            <div class="order-status-badge">
                                <i class="pi pi-check-circle"></i>
                                <span>Listo para servir</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Empty state -->
            <div class="empty-state-card" *ngIf="!kitchenItems || kitchenItems.length === 0">
                <div class="empty-icon"><i class="pi pi-box"></i></div>
                <h3 class="empty-title">Sin órdenes de cocina</h3>
                <p class="empty-message">Las nuevas órdenes aparecerán aquí automáticamente</p>
            </div>
        </p-tabPanel>

        <!-- BAR TAB -->
        <p-tabPanel header="Bar" leftIcon="pi pi-filter">
            <!-- Kanban Columns for Bar -->
            <div class="kanban-board" *ngIf="barItems && barItems.length > 0">
                <!-- Column: Pendientes -->
                <div class="kanban-column">
                    <div class="column-header glass-card">
                        <div class="column-title">
                            <i class="pi pi-clock"></i>
                            <h3>Pendientes</h3>
                        </div>
                        <p-tag [value]="getPendingBarOrders().length.toString()" severity="info"></p-tag>
                    </div>
                    <div class="column-content">
                        <div *ngFor="let order of getPendingBarOrders(); let i = index"
                             class="order-card glass-card hover-lift stagger-item"
                             [class.order-urgent]="getSeverity(order.createdAt) === 'danger'"
                             [class.order-warning]="getSeverity(order.createdAt) === 'warning'"
                             [style.animation-delay]="(i * 0.05) + 's'">
                            
                            <app-order-timer [startTime]="order.createdAt"></app-order-timer>

                            <div class="order-table">
                                <i class="pi pi-table"></i>
                                <span>{{order.table?.name}}</span>
                            </div>

                            <div class="order-item">
                                <span class="order-quantity">{{order.quantity}}x</span>
                                <span class="order-name">{{order.meal?.name}}</span>
                            </div>

                            <div class="order-notes" *ngIf="order.aditional">
                                <i class="pi pi-comment"></i>
                                <span>{{order.aditional}}</span>
                            </div>

                            <div class="order-actions">
                                <button pButton 
                                        *ngIf="isOnlineOrder(order)"
                                        label="Cancelar" 
                                        severity="danger" 
                                        icon="pi pi-times"
                                        [outlined]="true"
                                        size="small"
                                        (click)="cancelOrder($event, order)"></button>
                                
                                <button pButton 
                                        label="Iniciar Preparación" 
                                        severity="warning" 
                                        icon="pi pi-cog"
                                        class="w-full"
                                        (click)="changeStatusOrder($event, order, 2)"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column: En Preparación -->
                <div class="kanban-column">
                    <div class="column-header glass-card">
                        <div class="column-title">
                            <i class="pi pi-cog"></i>
                            <h3>En Preparación</h3>
                        </div>
                        <p-tag [value]="getInProgressBarOrders().length.toString()" severity="warning"></p-tag>
                    </div>
                    <div class="column-content">
                        <div *ngFor="let order of getInProgressBarOrders(); let i = index"
                             class="order-card glass-card hover-lift stagger-item"
                             [class.order-urgent]="getSeverity(order.createdAt) === 'danger'"
                             [style.animation-delay]="(i * 0.05) + 's'">
                            
                            <app-order-timer [startTime]="order.createdAt"></app-order-timer>

                            <div class="order-table">
                                <i class="pi pi-table"></i>
                                <span>{{order.table?.name}}</span>
                            </div>

                            <div class="order-item">
                                <span class="order-quantity">{{order.quantity}}x</span>
                                <span class="order-name">{{order.meal?.name}}</span>
                            </div>

                            <div class="order-notes" *ngIf="order.aditional">
                                <i class="pi pi-comment"></i>
                                <span>{{order.aditional}}</span>
                            </div>

                            <div class="order-actions">
                                <button pButton 
                                        label="Marcar como Listo" 
                                        severity="success" 
                                        icon="pi pi-check"
                                        class="w-full"
                                        (click)="changeStatusOrder($event, order, 3)"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column: Listos -->
                <div class="kanban-column">
                    <div class="column-header glass-card">
                        <div class="column-title">
                            <i class="pi pi-check-circle"></i>
                            <h3>Listos</h3>
                        </div>
                        <p-tag [value]="getReadyBarOrders().length.toString()" severity="success"></p-tag>
                    </div>
                    <div class="column-content">
                        <div *ngFor="let order of getReadyBarOrders(); let i = index"
                             class="order-card glass-card hover-lift stagger-item ready-card"
                             [style.animation-delay]="(i * 0.05) + 's'">
                            
                            <app-order-timer [startTime]="order.createdAt"></app-order-timer>

                            <div class="order-table">
                                <i class="pi pi-table"></i>
                                <span>{{order.table?.name}}</span>
                            </div>

                            <div class="order-item">
                                <span class="order-quantity">{{order.quantity}}x</span>
                                <span class="order-name">{{order.meal?.name}}</span>
                            </div>

                            <div class="order-status-badge">
                                <i class="pi pi-check-circle"></i>
                                <span>Listo para servir</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="empty-state-card" *ngIf="!barItems || barItems.length === 0">
                <div class="empty-icon"><i class="pi pi-filter"></i></div>
                <h3 class="empty-title">Sin órdenes de bar</h3>
                <p class="empty-message">Las nuevas bebidas aparecerán aquí automáticamente</p>
            </div>
        </p-tabPanel>

        <!-- EXPO TAB -->
        <p-tabPanel header="Expo" leftIcon="pi pi-list">
            <div class="expo-grid" *ngIf="expoItems && expoItems.length > 0">
                <div *ngFor="let ticket of expoItems" class="expo-ticket glass-card">
                    <div class="ticket-header">
                        <h3>{{ticket.tableName}}</h3>
                        <app-order-timer [startTime]="ticket.createdAt"></app-order-timer>
                    </div>
                    
                    <div class="ticket-items">
                        <div *ngFor="let item of ticket.items" class="ticket-item">
                            <div class="item-info">
                                <span class="item-qty">{{item.quantity}}x</span>
                                <span class="item-name">{{item.meal?.name}}</span>
                                <span class="item-notes" *ngIf="item.aditional">{{item.aditional}}</span>
                            </div>
                            <p-tag [value]="item.statusOrderId == 2 ? 'Prep' : (item.statusOrderId == 3 ? 'Listo' : 'Pend')" 
                                   [severity]="item.statusOrderId == 3 ? 'success' : (item.statusOrderId == 2 ? 'warning' : 'info')"></p-tag>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="empty-state-card" *ngIf="!expoItems || expoItems.length === 0">
                <div class="empty-icon"><i class="pi pi-list"></i></div>
                <h3 class="empty-title">Sin tickets activos</h3>
                <p class="empty-message">Los tickets de las mesas aparecerán aquí</p>
            </div>
        </p-tabPanel>

        <!-- HISTORY TAB -->
        <p-tabPanel header="Historial" leftIcon="pi pi-history">
            <div class="history-grid" *ngIf="historyItems && historyItems.length > 0">
                <div *ngFor="let order of historyItems" class="history-item">
                    <div class="history-time">{{order.createdAt | date:'shortTime'}}</div>
                    <div class="history-table">{{order.table?.name}}</div>
                    <div class="history-meal">{{order.quantity}}x {{order.meal?.name}}</div>
                    <p-tag value="Completado" severity="success"></p-tag>
                </div>
            </div>
            
            <div class="empty-state-card" *ngIf="!historyItems || historyItems.length === 0">
                <div class="empty-icon"><i class="pi pi-history"></i></div>
                <h3 class="empty-title">Sin historial</h3>
                <p class="empty-message">Las órdenes completadas aparecerán aquí</p>
            </div>
        </p-tabPanel>
    </p-tabView>
</div>

<!-- Confirmation Dialog -->
<p-confirmDialog #cd>
    <ng-template pTemplate="headless" let-message>
        <div class="confirm-dialog-content">
            <div class="confirm-icon">
                <i class="pi pi-question"></i>
            </div>
            <h3>{{message.header}}</h3>
            <p>{{message.message}}</p>
            <div class="confirm-actions">
                <button pButton label="Sí" (click)="cd.accept()"></button>
                <button pButton label="No" severity="secondary" [outlined]="true" (click)="cd.reject()"></button>
            </div>
        </div>
    </ng-template>
</p-confirmDialog>

<p-overlayPanel #op [style]="{width: '450px'}" [showCloseIcon]="true">
    <ng-template pTemplate="content">
        <div class="overlay-content">{{coments}}</div>
    </ng-template>
</p-overlayPanel>
