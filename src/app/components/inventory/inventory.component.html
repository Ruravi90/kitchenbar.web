<!-- Inventory Component - Glassmorphism Styles -->

<div class="inventory-container">
  <p-card header="Gestión de Inventario">
    <!-- Search and Actions -->
    <div class="mb-4 flex flex-wrap gap-3 align-items-center">
      <span class="p-input-icon-left flex-1" style="min-width: 250px">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          placeholder="Buscar por nombre..."
          [(ngModel)]="searchTerm"
          (input)="filterItems()"
          class="w-full"
        />
      </span>
      <p-button
        label="Nuevo Item"
        icon="pi pi-plus"
        (onClick)="openNew()"
        styleClass="flex-shrink-0"
      >
      </p-button>
    </div>

    <!-- Table -->
    <p-table
      [value]="filteredItems"
      [rows]="10"
      [paginator]="true"
      [tableStyle]="{ 'min-width': '50rem' }"
      [rowHover]="true"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="meal.name">
            Platillo
            <p-sortIcon field="meal.name"></p-sortIcon>
          </th>
          <th pSortableColumn="name">
            Nombre (Ingrediente)
            <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="stock" class="text-center">
            Stock
            <p-sortIcon field="stock"></p-sortIcon>
          </th>
          <th pSortableColumn="cost" class="text-right">
            Costo
            <p-sortIcon field="cost"></p-sortIcon>
          </th>
          <th pSortableColumn="unit_measure.name">
            Unidad
            <p-sortIcon field="unit_measure.name"></p-sortIcon>
          </th>
          <th style="width: 200px">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item>
        <tr [class.highlighted-row]="item.id === highlightedItemId">
          <td>{{ item.meal?.name || "---" }}</td>
          <td>{{ item.name || "---" }}</td>
          <td class="text-center">
            <span
              [class.text-red-500]="item.stock < 10"
              [class.text-orange-500]="item.stock >= 10 && item.stock < 50"
              [class.text-green-500]="item.stock >= 50"
              class="font-bold"
            >
              {{ item.stock }}
            </span>
          </td>
          <td class="text-right">${{ item.cost | number : "1.2-2" }}</td>
          <td>{{ item.unit_measure?.name || "N/A" }}</td>
          <td>
            <div class="flex gap-2 justify-content-center">
              <p-button
                icon="pi pi-pencil"
                [rounded]="true"
                severity="warning"
                (onClick)="editItem(item)"
                pTooltip="Editar"
                tooltipPosition="top"
              >
              </p-button>
              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                severity="danger"
                (onClick)="deleteItem(item)"
                pTooltip="Eliminar"
                tooltipPosition="top"
              >
              </p-button>
              <p-button
                icon="pi pi-exclamation-triangle"
                [rounded]="true"
                severity="help"
                (onClick)="openWaste(item)"
                pTooltip="Reportar Merma"
                tooltipPosition="top"
              >
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty State -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center py-6">
            <div class="empty-state">
              <i class="pi pi-inbox empty-icon"></i>
              <p class="empty-title">No hay items en el inventario</p>
              <p class="empty-subtitle">Comienza agregando tu primer item</p>
              <p-button
                label="Agregar Item"
                icon="pi pi-plus"
                (onClick)="openNew()"
                styleClass="mt-3"
              >
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Edit/New Dialog -->
<p-dialog
  [(visible)]="itemDialog"
  [style]="{ width: '500px' }"
  header="Detalles de Inventario"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <form [formGroup]="itemForm">
      <!-- Type Selection -->
      <div class="field mb-4">
        <label>
          Tipo
          <i
            class="pi pi-info-circle ml-2 tooltip-icon"
            pTooltip="Selecciona si es un platillo preparado o un ingrediente puro"
            tooltipPosition="right"
          ></i>
        </label>
        <div class="flex gap-4 mt-2">
          <div class="flex align-items-center">
            <p-radioButton
              name="type"
              value="meal"
              [(ngModel)]="inventoryType"
              [ngModelOptions]="{ standalone: true }"
              inputId="type1"
            >
            </p-radioButton>
            <label for="type1" class="ml-2">Platillo</label>
          </div>
          <div class="flex align-items-center">
            <p-radioButton
              name="type"
              value="ingredient"
              [(ngModel)]="inventoryType"
              [ngModelOptions]="{ standalone: true }"
              inputId="type2"
            >
            </p-radioButton>
            <label for="type2" class="ml-2">Ingrediente Puro</label>
          </div>
        </div>
      </div>

      <!-- Meal Selection -->
      <div class="field" *ngIf="inventoryType === 'meal'">
        <label for="meal">
          Platillo *
          <i
            class="pi pi-info-circle ml-2 tooltip-icon"
            pTooltip="Selecciona el platillo del menú"
            tooltipPosition="right"
          ></i>
        </label>
        <p-dropdown
          id="meal"
          [options]="meals"
          [(ngModel)]="selectedMeal"
          [ngModelOptions]="{ standalone: true }"
          optionLabel="name"
          placeholder="Selecciona un Platillo"
          [filter]="true"
          filterBy="name"
          [showClear]="true"
          appendTo="body"
          [class.p-invalid]="
            submitted && inventoryType === 'meal' && !selectedMeal
          "
        >
        </p-dropdown>
        <small
          class="p-error"
          *ngIf="submitted && inventoryType === 'meal' && !selectedMeal"
        >
          Platillo es requerido
        </small>
      </div>

      <!-- Ingredient Name -->
      <div class="field" *ngIf="inventoryType === 'ingredient'">
        <label for="name">
          Nombre del Ingrediente *
          <i
            class="pi pi-info-circle ml-2 tooltip-icon"
            pTooltip="Nombre descriptivo del ingrediente"
            tooltipPosition="right"
          ></i>
        </label>
        <input
          type="text"
          pInputText
          id="name"
          formControlName="name"
          placeholder="Ej: Arroz, Aceite, Sal..."
          [class.p-invalid]="
            submitted &&
            inventoryType === 'ingredient' &&
            itemForm.get('name')?.invalid
          "
        />
        <small
          class="p-error"
          *ngIf="
            submitted &&
            inventoryType === 'ingredient' &&
            itemForm.get('name')?.invalid
          "
        >
          Nombre es requerido
        </small>
      </div>

      <!-- Stock -->
      <div class="field">
        <label for="stock">
          Stock Actual *
          <i
            class="pi pi-info-circle ml-2 tooltip-icon"
            pTooltip="Cantidad disponible en inventario"
            tooltipPosition="right"
          ></i>
        </label>
        <p-inputNumber
          id="stock"
          formControlName="stock"
          placeholder="0"
          [min]="0"
          [class.p-invalid]="submitted && itemForm.get('stock')?.invalid"
        >
        </p-inputNumber>
        <small
          class="p-error"
          *ngIf="submitted && itemForm.get('stock')?.invalid"
        >
          Stock es requerido
        </small>
      </div>

      <!-- Cost -->
      <div class="field">
        <label for="cost">
          Costo Unitario *
          <i
            class="pi pi-info-circle ml-2 tooltip-icon"
            pTooltip="Precio por unidad de medida"
            tooltipPosition="right"
          ></i>
        </label>
        <p-inputNumber
          id="cost"
          formControlName="cost"
          mode="currency"
          currency="USD"
          locale="en-US"
          placeholder="$0.00"
          [min]="0"
          [class.p-invalid]="submitted && itemForm.get('cost')?.invalid"
        >
        </p-inputNumber>
        <small
          class="p-error"
          *ngIf="submitted && itemForm.get('cost')?.invalid"
        >
          Costo es requerido
        </small>
      </div>

      <!-- Unit Measure -->
      <div class="field">
        <label for="unitMeasure">
          Unidad de Medida *
          <i
            class="pi pi-info-circle ml-2 tooltip-icon"
            pTooltip="Unidad en la que se mide este item"
            tooltipPosition="right"
          ></i>
        </label>
        <p-dropdown
          id="unitMeasure"
          [options]="unitMeasures"
          [(ngModel)]="selectedUnitMeasure"
          [ngModelOptions]="{ standalone: true }"
          optionLabel="name"
          placeholder="Selecciona una Unidad"
          appendTo="body"
          [class.p-invalid]="submitted && !selectedUnitMeasure"
        >
        </p-dropdown>
        <small class="p-error" *ngIf="submitted && !selectedUnitMeasure">
          Unidad de medida es requerida
        </small>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button label="Cancelar" severity="secondary" (onClick)="hideDialog()">
      </p-button>
      <p-button label="Guardar" (onClick)="saveItem()"> </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Waste Dialog -->
<p-dialog
  [(visible)]="wasteDialog"
  [style]="{ width: '450px' }"
  header="Reportar Merma"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div class="field">
      <label>Item</label>
      <input
        pInputText
        [disabled]="true"
        [value]="wasteItem?.meal?.name || wasteItem?.name"
      />
    </div>

    <div class="field">
      <label for="wasteQty">
        Cantidad Perdida *
        <i
          class="pi pi-info-circle ml-2 tooltip-icon"
          pTooltip="Cantidad de merma a reportar"
          tooltipPosition="right"
        ></i>
      </label>
      <p-inputNumber
        id="wasteQty"
        [(ngModel)]="wasteQuantity"
        [min]="0"
        [max]="wasteItem?.stock"
        placeholder="0"
      >
      </p-inputNumber>
      <small class="text-500 mt-1 block">
        Stock actual: {{ wasteItem?.stock || 0 }}
      </small>
    </div>

    <div class="field">
      <label for="reason">
        Razón *
        <i
          class="pi pi-info-circle ml-2 tooltip-icon"
          pTooltip="Selecciona o escribe la razón de la merma"
          tooltipPosition="right"
        ></i>
      </label>
      <p-dropdown
        [options]="wasteReasons"
        [(ngModel)]="wasteReason"
        placeholder="Selecciona o escribe razón"
        [editable]="true"
      >
      </p-dropdown>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        label="Cancelar"
        severity="secondary"
        (onClick)="hideWasteDialog()"
      >
      </p-button>
      <p-button
        label="Confirmar Merma"
        severity="danger"
        (onClick)="confirmWaste()"
      >
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
