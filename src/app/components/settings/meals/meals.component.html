<div class="meals-container">
    <!-- Page Header -->
    <div class="page-header glass-card mb-4">
        <div class="page-title">
            <h1>Gestión de Alimentos</h1>
            <p class="page-subtitle">Administra tu menú de platillos y bebidas</p>
        </div>
    </div>

    <!-- Content Card -->
    <div class="content-card glass-card">
        <div>
            <p-inputGroup class="w-full mb-4">
                <p-inputGroupAddon>
                    <i class="pi pi-search"></i>
                </p-inputGroupAddon>
                <input type="text" 
                       pInputText 
                       placeholder="Buscar por nombre..." 
                       [(ngModel)]="searchTerm"
                       (input)="filterMeals()" />
                <button type="button" 
                        pButton 
                        icon="pi pi-plus" 
                        class="p-button-success" 
                        size="small"  
                        pTooltip="Nuevo alimento/bebida"  
                        (click)="showModal()"></button>
            </p-inputGroup>

            <p-table [value]="filteredItems" 
                     [paginator]="true" 
                     [rows]="5" 
                     responsiveLayout="scroll" 
                     styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Nombre</th>
                        <th class="text-center" style="width: 120px">Acciones</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item>
                    <tr [class.highlighted-row]="item.id === highlightedMealId">
                        <td>{{item.name}}</td>
                        <td class="text-center">
                            <div class="flex justify-content-center gap-2">
                                <p-button icon="pi pi-pencil" 
                                          [rounded]="true" 
                                          [outlined]="false" 
                                          severity="warning" 
                                          size="small" 
                                          pTooltip="Editar platillo" 
                                          (click)="showModal(true, item)" 
                                          class="mr-2"/>
                                <p-button icon="pi pi-trash" 
                                          [rounded]="true" 
                                          [outlined]="false" 
                                          severity="danger" 
                                          size="small" 
                                          pTooltip="Eliminar platillo" 
                                          (click)="confirmDeleted(item)"/>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="2" class="text-center py-6">
                            <div class="empty-state">
                                <i class="pi pi-pizza-slice empty-icon"></i>
                                <h3 class="empty-title">No hay alimentos/bebidas registrados</h3>
                                <p class="empty-subtitle">Comienza agregando tu primer platillo al menú</p>
                                <p-button label="Agregar Platillo" 
                                          icon="pi pi-plus" 
                                          (click)="showModal()"
                                          class="mt-3"></p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>
<p-dialog header="{{isEdit?'Editar':'Nuevo'}} alimento/bebida" [modal]="true" [(visible)]="visibleModal" >
    <p-tabView>
        <p-tabPanel header="Información Básica">
            <form [formGroup]="mealForm" class="formgrid grid gap-3 mb-3 mt-3">
                <div class="field col-12">
                    <label for="category">
                        Categoría *
                        <i class="pi pi-info-circle ml-2 tooltip-icon" 
                           pTooltip="Selecciona la categoría del platillo" 
                           tooltipPosition="right"></i>
                    </label>
                    <p-dropdown 
                        id="category"
                        [style]="{'width':'100%'}"
                        [options]="categories" 
                        formControlName="categoryId"
                        optionLabel="name"
                        optionValue="id"
                        placeholder="Selecciona la categoria" />
                    <small class="p-error" *ngIf="mealForm.get('categoryId')?.invalid && mealForm.get('categoryId')?.touched">
                        La categoría es requerida
                    </small>
                </div>
                <div class="field col-12">
                    <label for="mealName">
                        Nombre de alimento / bebida *
                        <i class="pi pi-info-circle ml-2 tooltip-icon" 
                           pTooltip="Mínimo 3 caracteres" 
                           tooltipPosition="right"></i>
                    </label>
                    <input id="mealName" 
                           type="text" 
                           formControlName="name"
                           pInputText
                           class="w-full"
                           placeholder="Ej: Hamburguesa especial">
                    <small class="p-error" *ngIf="mealForm.get('name')?.invalid && mealForm.get('name')?.touched">
                        <span *ngIf="mealForm.get('name')?.errors?.['required']">El nombre es requerido</span>
                        <span *ngIf="mealForm.get('name')?.errors?.['minlength']">Mínimo 3 caracteres</span>
                    </small>
                </div>
                <div class="field col-12">
                    <label for="price">
                        Precio *
                        <i class="pi pi-info-circle ml-2 tooltip-icon" 
                           pTooltip="Precio de venta al público" 
                           tooltipPosition="right"></i>
                    </label>
                    <input id="price" 
                           type="number" 
                           formControlName="price"
                           pInputText
                           class="w-full"
                           placeholder="0.00"
                           min="0"
                           step="0.01">
                    <small class="p-error" *ngIf="mealForm.get('price')?.invalid && mealForm.get('price')?.touched">
                        <span *ngIf="mealForm.get('price')?.errors?.['required']">El precio es requerido</span>
                        <span *ngIf="mealForm.get('price')?.errors?.['min']">El precio debe ser mayor a 0</span>
                    </small>
                </div>
            </form>
        </p-tabPanel>
        <p-tabPanel header="Receta (Ingredientes)">
            <!-- Instructions for new meals -->
            <div *ngIf="!meal.id && pendingRecipes.length === 0" class="text-center p-4">
                <i class="pi pi-info-circle text-4xl text-primary mb-3"></i>
                <p class="text-lg mb-2">Agrega ingredientes a tu receta</p>
                <p class="text-500">Puedes agregar ingredientes ahora. Se guardarán automáticamente al crear el platillo.</p>
            </div>

            <!-- Add ingredient form -->
            <div class="formgrid grid gap-3 mb-4 align-items-end">
                <div class="field col-5">
                    <label>
                        Ingrediente *
                        <i class="pi pi-info-circle ml-2 tooltip-icon" 
                           pTooltip="Busca y selecciona un ingrediente del inventario" 
                           tooltipPosition="right"></i>
                    </label>
                    <p-dropdown 
                        [options]="inventoryItems" 
                        [(ngModel)]="selectedInventoryItem" 
                        optionLabel="name"
                        [filter]="true"
                        filterBy="name"
                        placeholder="Buscar ingrediente..."
                        [style]="{'width':'100%'}" 
                        appendTo="body">
                        <ng-template let-item pTemplate="item">
                            <div class="flex justify-content-between align-items-center w-full">
                                <span>{{ item.name }}</span>
                                <span class="text-sm text-500" *ngIf="item.stock">
                                    Stock: {{ item.stock }}
                                </span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
                
                <div class="field col-3">
                    <label>
                        Cantidad *
                        <i class="pi pi-info-circle ml-2 tooltip-icon" 
                           pTooltip="Cantidad a usar por platillo" 
                           tooltipPosition="right"></i>
                    </label>
                    <p-inputNumber 
                        [(ngModel)]="newRecipe.quantity"
                        [min]="0.01"
                        [step]="0.1"
                        mode="decimal"
                        [minFractionDigits]="2"
                        [maxFractionDigits]="2"
                        placeholder="0.00"
                        class="w-full">
                    </p-inputNumber>
                </div>
                
                <div class="field col-2 flex align-items-end pb-2">
                    <div class="w-full text-center">
                        <label class="block mb-2 text-sm">Costo</label>
                        <div class="text-xl font-bold text-primary">
                            ${{ calculateIngredientCost() | number:'1.2-2' }}
                        </div>
                    </div>
                </div>
                
                <div class="field col-2 flex align-items-end">
                    <p-button 
                        icon="pi pi-plus" 
                        label="Agregar"
                        (click)="addRecipeToList()"
                        [disabled]="!selectedInventoryItem || !newRecipe.quantity"
                        styleClass="w-full">
                    </p-button>
                </div>
            </div>

            <!-- Pending recipes table -->
            <div class="recipe-preview mt-4" *ngIf="pendingRecipes.length > 0 || (!meal.id && pendingRecipes.length === 0)">
                <h4 class="mb-3">
                    <i class="pi pi-list mr-2"></i>
                    Ingredientes de la receta
                </h4>
                
                <p-table [value]="pendingRecipes" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Ingrediente</th>
                            <th class="text-center">Cantidad</th>
                            <th>Unidad</th>
                            <th class="text-right">Costo Unit.</th>
                            <th class="text-right">Costo Total</th>
                            <th style="width: 60px"></th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-recipe let-i="rowIndex">
                        <tr>
                            <td>
                                <i class="pi pi-box mr-2 text-500"></i>
                                {{ recipe.inventoryName }}
                            </td>
                            <td class="text-center font-bold">{{ recipe.quantity | number:'1.2-2' }}</td>
                            <td class="text-500">{{ recipe.unitMeasure }}</td>
                            <td class="text-right">${{ recipe.unitCost | number:'1.2-2' }}</td>
                            <td class="text-right font-bold text-primary">${{ recipe.totalCost | number:'1.2-2' }}</td>
                            <td class="text-center">
                                <p-button 
                                    icon="pi pi-trash" 
                                    [text]="true"
                                    severity="danger"
                                    size="small"
                                    pTooltip="Eliminar ingrediente"
                                    (click)="removePendingRecipe(i)">
                                </p-button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="footer">
                        <tr class="bg-primary-50">
                            <td colspan="4" class="text-right font-bold">Costo Total de Ingredientes:</td>
                            <td class="text-right font-bold text-primary text-xl">
                                ${{ getTotalRecipeCost() | number:'1.2-2' }}
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-right">Precio de Venta:</td>
                            <td class="text-right font-semibold">
                                ${{ mealForm.get('price')?.value | number:'1.2-2' }}
                            </td>
                            <td></td>
                        </tr>
                        <tr class="border-top-2 border-300">
                            <td colspan="4" class="text-right font-bold text-lg">Margen de Ganancia:</td>
                            <td class="text-right font-bold text-lg" 
                                [class.text-green-600]="getProfitMargin() > 60"
                                [class.text-orange-600]="getProfitMargin() >= 30 && getProfitMargin() <= 60"
                                [class.text-red-600]="getProfitMargin() < 30">
                                {{ getProfitMargin() | number:'1.1-1' }}%
                                <i class="ml-2"
                                   [class.pi-check-circle]="getProfitMargin() > 60"
                                   [class.pi-exclamation-triangle]="getProfitMargin() >= 30 && getProfitMargin() <= 60"
                                   [class.pi-times-circle]="getProfitMargin() < 30"></i>
                            </td>
                            <td></td>
                        </tr>
                        <tr *ngIf="getProfitMargin() > 0 && getProfitMargin() < 30">
                            <td colspan="6" class="text-center py-2">
                                <div class="p-3 bg-orange-100 border-round">
                                    <i class="pi pi-exclamation-triangle text-orange-600 mr-2"></i>
                                    <span class="text-orange-900">Margen bajo. Se recomienda un mínimo de 30% para cubrir gastos operativos.</span>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="pi pi-shopping-cart text-5xl text-400"></i>
                                <p class="mt-3 text-lg text-500">Agrega ingredientes a la receta</p>
                                <p class="text-sm text-400">Selecciona un ingrediente y cantidad arriba</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Existing recipes (for already saved meals) -->
            <div *ngIf="meal.id && currentRecipes.length > 0" class="mt-4">
                <h4 class="mb-3">
                    <i class="pi pi-database mr-2"></i>
                    Ingredientes guardados
                </h4>
                <p-table [value]="currentRecipes" styleClass="p-datatable-sm" [scrollable]="true" scrollHeight="200px">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Ingrediente</th>
                            <th>Cantidad</th>
                            <th>Unidad</th>
                            <th style="width: 50px"></th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-recipe>
                        <tr>
                            <td>{{ recipe.inventory?.name || recipe.inventory?.meal?.name }}</td>
                            <td>{{ recipe.quantity }}</td>
                            <td>Unidad</td>
                            <td>
                                <button pButton icon="pi pi-trash" class="p-button-danger p-button-text p-button-sm" (click)="deleteRecipe(recipe.id)"></button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="4" class="text-center">No hay ingredientes asignados.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-tabPanel>
    </p-tabView>
    <div class="flex justify-content-end gap-2">
        <p-button label="Cancelar" severity="secondary" (click)="visibleModal = false" />
        <p-button label="Guardar" (click)="confirmSave()" />
    </div>
</p-dialog>
<p-toast />
<p-confirmDialog #cd>
    <ng-template pTemplate="headless" let-message>
        <div class="flex flex-column align-items-center p-5 surface-overlay border-round">
            <div class="border-circle bg-primary inline-flex justify-content-center align-items-center h-6rem w-6rem">
                <i class="pi pi-question text-5xl"></i>
            </div>
            <span class="font-bold text-2xl block mb-2 mt-4">
                {{ message.header }}
            </span>
            <p class="mb-0">{{ message.message }}</p>
            <div class="flex align-items-center gap-2 mt-4">
                <button 
                    pButton 
                    label="Si" 
                    (click)="cd.accept()" 
                    class="w-8rem">
                </button>
                <button 
                    pButton 
                    label="No" 
                    (click)="cd.reject()" 
                    class="p-button-outlined w-8rem ">
                </button>
            </div>
        </div>
    </ng-template>
</p-confirmDialog>