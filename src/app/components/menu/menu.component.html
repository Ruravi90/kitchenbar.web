<div class="menu-container fade-in">
  <!-- Category Navigation -->
  <div
    class="category-nav sticky top-0 z-5 surface-0 py-3 px-3 shadow-1 mb-4 flex gap-2 overflow-x-auto"
  >
    <button
      pButton
      class="p-button-rounded p-button-text white-space-nowrap flex-shrink-0"
      [class.p-button-outlined]="selectedCategory?.id !== cat.id"
      [class.font-bold]="selectedCategory?.id === cat.id"
      *ngFor="let cat of categoryOptions"
      (click)="onCategoryChange(cat)"
      [label]="cat.name"
    ></button>
  </div>

  <!-- Menu List -->
  <div class="menu-list px-3 md:px-5 pb-8">
    <div *ngFor="let group of groupedMeals" class="mb-6">
      <h2
        class="text-3xl font-serif text-900 mb-4 border-bottom-1 surface-border pb-2"
      >
        {{ group.category.name }}
      </h2>

      <div class="grid grid-nogutter">
        <div *ngFor="let meal of group.meals" class="col-12 mb-4 meal-item">
          <div class="flex justify-content-between align-items-start gap-3">
            <div class="flex-1 cursor-pointer" (click)="showDetails(meal)">
              <div class="flex align-items-baseline gap-2 mb-1">
                <h3 class="text-xl font-medium text-900 m-0">
                  {{ meal.name }}
                </h3>
                <span class="text-lg font-semibold text-primary">{{
                  "$" + meal.price
                }}</span>
              </div>
              <p class="text-700 m-0 line-height-3 text-sm md:text-base mb-2">
                {{ meal.description }}
              </p>
              <div
                class="flex align-items-center gap-2"
                (click)="$event.stopPropagation()"
              >
                <p-rating
                  [(ngModel)]="meal.rating"
                  [cancel]="false"
                  (onRate)="onRate(meal, $event)"
                ></p-rating>
                <span class="text-sm text-600"
                  >({{ meal.ratingCount || 0 }})</span
                >
              </div>
            </div>

            <button
              pButton
              icon="pi pi-plus"
              class="p-button-rounded p-button-text p-button-sm flex-shrink-0"
              [disabled]="meal.inventoryStatus === 'OUTOFSTOCK'"
              (click)="addToCart(meal)"
            ></button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="groupedMeals.length === 0" class="text-center p-5 text-700">
      No se encontraron platillos.
    </div>
  </div>
</div>

<button
  pButton
  icon="pi pi-arrow-left"
  class="fixed bottom-0 left-0 m-4 z-5 shadow-4 p-button-rounded p-button-secondary"
  (click)="goBack()"
  *ngIf="tableId"
></button>
<button
  pButton
  icon="pi pi-shopping-cart"
  label="Carrito ({{ cart.length }})"
  class="fixed bottom-0 right-0 m-4 z-5 shadow-4"
  (click)="cartVisible = true"
  *ngIf="cart.length > 0"
></button>

<button
  pButton
  icon="pi pi-user"
  label="Mi Cuenta"
  class="fixed bottom-0 right-0 m-4 z-5 shadow-4 mr-8"
  style="margin-right: 150px !important"
  (click)="accountVisible = true"
  *ngIf="dinerId"
></button>

<p-dialog
  [(visible)]="cartVisible"
  [style]="{ width: '450px' }"
  header="Tu Orden"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div *ngIf="cart.length === 0" class="text-center">
      Tu carrito está vacío.
    </div>
    <div
      *ngFor="let item of cart; let i = index"
      class="flex align-items-center justify-content-between mb-3 border-bottom-1 surface-border pb-2"
    >
      <div>
        <div class="font-bold">{{ item.name }}</div>
        <div class="text-sm text-600">{{ "$" + item.price }}</div>
      </div>
      <button
        pButton
        icon="pi pi-trash"
        class="p-button-rounded p-button-danger p-button-text p-button-sm"
        pTooltip="Eliminar"
        (click)="removeFromCart(i)"
      ></button>
    </div>
    <div
      class="flex justify-content-between font-bold text-xl mt-4"
      *ngIf="cart.length > 0"
    >
      <span>Total:</span>
      <span>{{ "$" + cartTotal }}</span>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cerrar"
      icon="pi pi-times"
      class="p-button-text"
      (click)="cartVisible = false"
    ></button>
    <button
      pButton
      label="Ordenar"
      icon="pi pi-check"
      [disabled]="cart.length === 0"
      (click)="placeOrder()"
    ></button>
  </ng-template>
</p-dialog>

<p-dialog
  [(visible)]="displayDetails"
  [style]="{ width: '450px' }"
  header="Detalles del Platillo"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div class="flex flex-column align-items-center p-4" *ngIf="selectedMeal">
      <div class="text-4xl font-serif font-bold mb-3 text-center text-900">
        {{ selectedMeal.name }}
      </div>
      <div class="w-3rem border-bottom-1 surface-border mb-4"></div>
      <p class="text-xl text-700 text-center line-height-3 mb-5 max-w-30rem">
        {{ selectedMeal.description }}
      </p>
      <div class="text-3xl font-medium text-primary">
        {{ "$" + selectedMeal.price }}
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cerrar"
      icon="pi pi-times"
      class="p-button-text"
      (click)="displayDetails = false"
    ></button>
    <button
      pButton
      label="Agregar al Carrito"
      icon="pi pi-check"
      class="p-button-text"
      (click)="addToCart(selectedMeal); displayDetails = false"
    ></button>
  </ng-template>
</p-dialog>

<p-dialog
  [(visible)]="accountVisible"
  [style]="{ width: '450px' }"
  header="Mi Cuenta"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div
      *ngIf="
        !dinerDetails ||
        !dinerDetails.orders ||
        dinerDetails.orders.length === 0
      "
      class="text-center"
    >
      No hay consumos registrados.
    </div>
    <div *ngIf="dinerDetails && dinerDetails.orders">
      <div
        *ngFor="let order of dinerDetails.orders"
        class="flex align-items-center justify-content-between mb-3 border-bottom-1 surface-border pb-2"
      >
        <div>
          <div class="font-bold">Platillo ID: {{ order.mealId }}</div>
          <div class="text-sm text-600">Cant: {{ order.quantity }}</div>
        </div>
      </div>
      <div class="flex justify-content-between font-bold text-xl mt-4">
        <span>Total:</span>
        <span>{{ "$" + dinerTotal }}</span>
      </div>
      <div class="mt-3 text-center">
        <span class="p-tag p-tag-success" *ngIf="dinerDetails.isPay"
          >PAGADO</span
        >
        <span class="p-tag p-tag-warning" *ngIf="!dinerDetails.isPay"
          >PENDIENTE DE PAGO</span
        >
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cerrar"
      icon="pi pi-times"
      class="p-button-text"
      (click)="accountVisible = false"
    ></button>
    <button
      pButton
      label="Pagar"
      icon="pi pi-dollar"
      class="p-button-success"
      *ngIf="dinerDetails && !dinerDetails.isPay"
      (click)="payTicket()"
    ></button>
    <button
      pButton
      label="Solicitar Factura"
      icon="pi pi-file"
      class="p-button-info"
      *ngIf="dinerDetails && dinerDetails.isPay"
      (click)="invoiceVisible = true; accountVisible = false"
    ></button>
  </ng-template>
</p-dialog>

<p-dialog
  [(visible)]="invoiceVisible"
  [style]="{ width: '450px' }"
  header="Datos de Facturación"
  [modal]="true"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div class="field">
      <label for="rfc">RFC</label>
      <input
        type="text"
        pInputText
        id="rfc"
        [(ngModel)]="fiscalData.rfc"
        required
      />
    </div>
    <div class="field">
      <label for="legalName">Razón Social</label>
      <input
        type="text"
        pInputText
        id="legalName"
        [(ngModel)]="fiscalData.legalName"
        required
      />
    </div>
    <div class="field">
      <label for="taxRegime">Régimen Fiscal (Código)</label>
      <input
        type="text"
        pInputText
        id="taxRegime"
        [(ngModel)]="fiscalData.taxRegime"
        placeholder="601"
        required
      />
    </div>
    <div class="field">
      <label for="zipCode">Código Postal</label>
      <input
        type="text"
        pInputText
        id="zipCode"
        [(ngModel)]="fiscalData.zipCode"
        required
      />
    </div>
    <div class="field">
      <label for="address">Dirección (Opcional)</label>
      <input
        type="text"
        pInputText
        id="address"
        [(ngModel)]="fiscalData.address"
      />
    </div>
    <div class="field">
      <label for="email">Correo Electrónico</label>
      <input
        type="email"
        pInputText
        id="email"
        [(ngModel)]="fiscalData.email"
        required
      />
    </div>
    <div class="field">
      <label for="useCfdi">Uso de CFDI</label>
      <input
        type="text"
        pInputText
        id="useCfdi"
        [(ngModel)]="fiscalData.useCfdi"
        placeholder="G03"
        required
      />
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cancelar"
      icon="pi pi-times"
      class="p-button-text"
      (click)="invoiceVisible = false"
    ></button>
    <button
      pButton
      label="Enviar"
      icon="pi pi-send"
      (click)="requestInvoice()"
    ></button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
